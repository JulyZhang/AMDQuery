<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <title></title>
  <link href="../../../global/styles/reset.css" rel="stylesheet" type="text/css" />
  <!-- <script src="http://192.168.1.102:8080/package/../../../amdquery/amdquery.js" type="text/javascript" amdquery="define:$;amd:false"></script>-->
  <script src="../../../amdquery/amdquery.js" type="text/javascript" amdquery="define:$;" amd="detectCR:1;" module="compatibleEvent:1;testLogByHTML:1"></script>
  <script type="text/javascript">
    $.require([
      "base/Promise",
      "main/event",
      "main/communicate",
      "module/Test"
    ], function(Promise, event, communicate, Test) {
      var jsonpPromise = new Promise;
      var TestCommunicate = new Test("TestCommunicate")
      .describe("Test JSONP", function(preResult, test, logger){
        $.once("jsonpStart", function(e){
          test(e.type).should.equal("jsonpStart");
        });

        $.once("jsonpStop", function(e){
          test(e.type).should.equal("jsonpStop");
        });

        var resolvePromise = new Promise(function(result){
          if(result){
            test(result).should.have.property("name").with.should.equal("Jarry");
            test(result).should.have.property("age").with.should.equal("28");
          }
          else{
            logger("jsonp fail");
            test(result).should.not.exists();
          }
        });

        var promise = communicate.jsonp({
          url: "http://jsfiddle.net/echo/jsonp",
          data: {
            name: "Jarry",
            age: "28"
          },
          timeout: 10000,
          complete: function(json){
            test(json).should.have.property("name").with.should.equal("Jarry");
            test(json).should.have.property("age").with.should.equal("28");
          },
          fail: function(options){
            test(options).should.have.property("timeout").with.should.equal(10000);
          }
        }).then(function(json){
          test(json).should.have.property("name").with.should.equal("Jarry");
          test(json).should.have.property("age").with.should.equal("28");
          return json;
        }, function(result){
          test(result).should.not.exists();
        }).done(resolvePromise);

        return resolvePromise;
      }).describe("Test JSONPS", function(preResult, test, logger){
        var resolvePromise = new Promise(function(result){
          if(result){
            test(result).should.have.property("length");
            test(result).should.have.index(1);
            json = result[1];
            test(json).should.have.property("name").with.should.equal("Amanda");
            test(json).should.have.property("age").with.should.equal("17");
          }
          else{
            logger("jsonps fail");
            test(result).should.not.exists();
          }
        });

        var promise = communicate.jsonps([{
          url: "http://jsfiddle.net/echo/jsonp",
          data: {
            name: "Jarry",
            age: "28"
          },
          complete: function(json){
            test(json).should.have.property("name").with.should.equal("Jarry");
            test(json).should.have.property("age").with.should.equal("28");
          },
          fail: function(options){
            test(options).should.have.property("timeout").with.should.equal(7000);
          }
        }, {
          url: "http://jsfiddle.net/echo/jsonp",
          data: {
            name: "Amanda",
            age: "17"
          }
        }, {
          url: "http://jsfiddle.net/echo/jsonp",
          data: {
            name: "Jake",
            age: "22"
          }
        }]).then(function(jsons){
          test(jsons).should.have.property("length");
          test(jsons).should.have.index(0);
          json = jsons[0];
          test(json).should.have.property("name").with.should.equal("Jarry");
          test(json).should.have.property("age").with.should.equal("28");
          return jsons;
        }).done(resolvePromise);

        return resolvePromise;
      }).describe("Test JSONPS fail", function(preResult, test, logger){
        var resolvePromise = new Promise(function(result){
          if(result){
            test(result).should.have.property("length");
          }
          else{
            logger("jsonps fail");
            test(result).should.not.exists();
          }
        });

        var promise = communicate.jsonps([{
          url: "http://jsfiddle.net/echo/jsonpaa",
          data: {
            name: "Jarry",
            age: "28"
          },
          complete: function(json){
            test(json).should.have.property("name").with.should.equal("Jarry");
            test(json).should.have.property("age").with.should.equal("28");
          },
          fail: function(options){
            test(options).should.have.property("timeout").with.should.equal(7000);
          }
        }, {
          url: "http://jsfiddle.net/echo/jsonp",
          data: {
            name: "Jake",
            age: "22"
          }
        }]).then(function(jsons){
          test(jsons).should.have.property("length");
          test(jsons).should.have.index(0);
          json = jsons[0];
          test(json).should.have.property("name").with.should.equal("Jarry");
          test(json).should.have.property("age").with.should.equal("28");
          return jsons;
        }).done(resolvePromise);

        return resolvePromise;
      }).start();
    });
  </script>
</head>

<body style="overflow: auto">
</body>

</html>
