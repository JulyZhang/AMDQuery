
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style="width: 100%;">

<head>
  <title></title>
  <link href="../css/reset.css" rel="stylesheet" type="text/css" />
  <style>
    #test {
      background: #0000FF;
      width: 100px;
      height: 100px;
    }
  </style>
  <script src="../../amdquery/amdquery.js" type="text/javascript" amdquery="define:$;" amd="detectCR:1;"></script>
  <script type="text/javascript">
    $.require("base/Promise", function(Promise) {
      var div = document.getElementsByTagName("div"),
        write = function(s) {
          div[0].innerHTML = div[0].innerHTML += s + "<br>";
        }

        function add1(num) {
          //write(num);
          a + num;
          return num;
        }

        function add(num, space) {
          space = space || "";
          write(space + "add: " + num + " + 1 = " + (num + 1));
          return num + 1;
        }

        function delay(ms) {
          return function(obj) {
            write("");
            write("delay " + ms + " begin");
            var promise = new Promise;
            var self = this;
            setTimeout(function() {
              write("delay " + ms + " stop");
              write("do together");
              //promise.resolve(obj);
              promise.together(self, obj);
            }, ms);
            return promise;
          };
        }

      var promise = new Promise(add1, function(num) {
        write("add1 is fail so: tag will save 'fail'")
        return add(num);
      })
        .then(function(num) {
          write("");
          write("tag back" + ";num:" + num);
          return num;
        })
        .and(delay(3000))
        .and(delay(2000))
        .and(delay(1000))
      //.then(delay(3000))
      .then(function(num) {
        write("ready!!!!!")
        return num
      })
        .then(function(num) {
          write(" ")
          write("already reBranch");
          return num;
        })
        .then(function(num) {
          return add(num, "--");
        })
        .then(function(num) {
          return add(num, "--");
        })
        .then(function(num) {
          return add(num, "--");
        })
        .then(function(num) {
          return add(num, "--");
        })
        .then(function(num) {
          return add(num, "--");
        })
        .rootResolve(0);

      setTimeout(function() {
        var back = promise
        write("");
        write("");
        write("tag back");
        write("setTimeout 6000...Is already done?");
        write("status:" + back.state);

        back
          .then(function(num) {
            write("");
            return num;
          })
          .then(function(num) {
            return add(num, "--");
          })

      }, 6000);

      var promiseDelete = new Promise(add1, add);
      promiseDelete.then(add)
        .and(add)
        .and(add)
        .then(add)
        .then(add)
        .then(add)
        .then(add)
        .root.destroy();
      write("");
      write("promiseDelete.thens.length:" + promiseDelete.thens.length);
      write("");
    });
  </script>
</head>

<body style="overflow: auto; width: 100%;">
  <div style="float: left; width: 29%;">
  </div>
</body>

</html>
