<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style="width: 100%;">
<head>
    <title></title>
    <link href="../../css/reset.css" rel="stylesheet" type="text/css" />
    <style>
        #test
        {
            background: #0000FF;
            width: 100px;
            height: 100px;
        }
    </style>
    <script src="../../myquery/myquery.js" type="text/javascript" myquery="define:$;" amd="detectCR:1;"></script>
    <script type="text/javascript">
        $.require("base/promise", function (Promise) {
            var div = document.getElementsByTagName("div")
                , write = function (s) {
                    div[0].innerHTML = div[0].innerHTML += s + "<br>";
                }

            function add1(num) {
                //write(num);
                a + num;
                return num;
            }
            function add(num, space) {
                space = space || "";
                write(space + "add: " + num + " + 1 = " + (num + 1));
                return num + 1;
            }

            function delay(ms) {
                return function (obj) {
                    write("");
                    write("delay " + ms + " begin");
                    var self = this;
                    setTimeout(function () {
                        write("delay " + ms + " stop");
                        write("do together");
                        //promise.resolve(obj);
                        self.together(self, obj);
                    }, ms);
                    return self;
                };
            }

            var promise = new Promise(add1, function (num) {
                write("init:" + this.checkout() + ";num:" + num);
                write("add1 is fail so: tag will save 'fail'")
                return add(num);
            })
            .tag("back")
            .then(function (num) {
                write("");
                write("tag back" + ";num:" + num);
                return num;
            })
            .and(delay(1000))
            .and(delay(2000))
            .and(delay(2500))
            .then(delay(3000))
            //promise.resolve(0);
            //.tag()获得是新promise
            .branch(function (num) {
                write("");
                write("--branche:" + this.checkout() + ";num:" + num)
                return num;
            }, "base1")
                .then(function (num) {
                    write("    ")
                    return add(num, "--");
                })
            .reBranch()
            .then(function (num) {
                write(" ")
                write("already reBranch");
                write("branche:" + this.checkout() + ";num:" + num);
                return num;
            })
            .branch(function (num) {
                write(" ")
                write("--branche:" + this.checkout() + ";num:" + num);
                return num;
            }, "base2")
            .then(function (num) {
                return add(num, "--");
            })
            .then(function (num) {
                return add(num, "--");
            })
            .branch(function (num) {
                write(" ");
                write("because branche base1 is exists,so branch is turn back")
                write("--branche:" + this.checkout() + ";num:" + num);
                return num;
            }, "base1")
            .then(function (num) {
                return add(num, "--");
            })
            .then(function (num) {
                return add(num, "--");
            })
            .then(function (num) {
                return add(num, "--");
            })
            .rootResolve(0);

            setTimeout(function () {
                var back = promise
                .tag("back");
                write("");
                write("");
                write("tag back");
                write("setTimeout 6000...Is already done?");
                write("branch:" + back.checkout());
                write("status:" + back.state);

                back
                .then(function (num) {
                    write("");
                    write("branch:" + this.checkout() + ";num:" + num)
                    return num;
                })
                .then(function (num) {
                    return add(num, "--");
                })

            }, 6000);

            var promiseDelete = new Promise(add1, add);
            promiseDelete.then(add)
            .and(add)
            .and(add)
            .then(add)
            .branch(add, "test1")
                .then(add)
            .reBranch()
                .then(add)
                .then(add)
            .removeTree();
            write("");
            write("promiseDelete.thens.length:" + promiseDelete.thens.length);
            write("");
        });
               
    </script>
</head>
<body style="overflow: auto; width: 100%;">
    <div style="float: left; width: 29%;">
    </div>
    <pre style="float: left; width: 69%;display:block;">
         $.require("base/promise", function (Promise) {
            var div = document.getElementsByTagName("div")
                , write = function (s) {
                    div[0].innerHTML = div[0].innerHTML += s + "&ltbr&gt";
                }

            function add1(num) {
                //write(num);
                a + num;
                return num;
            }
            function add(num, space) {
                space = space || "";
                write(space + "add: " + num + " + 1 = " + (num + 1));
                return num + 1;
            }

            function delay(ms) {
                return function (obj) {
                    write("");
                    write("delay " + ms + " begin");
                    var promise = new Promise(), self = this;
                    setTimeout(function () {
                        write("delay " + ms + " stop");
                        write("do together");
                        //promise.resolve(obj);
                        promise.together(self, obj);
                    }, ms);
                    return promise;
                };
            }

            var promise = new Promise(add1, function (num) {
                write("init:" + this.checkout() + ";num:" + num);
                write("add1 is fail so: tag will save 'fail'")
                return add(num);
            })
            .tag("back")
            .then(function (num) {
                write("");
                write("tag back" + ";num:" + num);
                return num;
            })
            .and(delay(1000))
            .and(delay(2000))
            .then(delay(3000))
            //promise.resolve(0);
            //.tag()获得是新promise
            .branch(function (num) {
                write("");
                write("--branche:" + this.checkout() + ";num:" + num)
                return num;
            }, "base1")
                .then(function (num) {
                    write("    ")
                    return add(num, "--");
                })
            .reBranch()
            .then(function (num) {
                write(" ")
                write("already reBranch");
                write("branche:" + this.checkout() + ";num:" + num);
                return num;
            })
            .branch(function (num) {
                write(" ")
                write("--branche:" + this.checkout() + ";num:" + num);
                return num;
            }, "base2")
            .then(function (num) {
                return add(num, "--");
            })
            .then(function (num) {
                return add(num, "--");
            })
            .branch(function (num) {
                write(" ");
                write("because branche base1 is exists,so branch is turn back")
                write("--branche:" + this.checkout() + ";num:" + num);
                return num;
            }, "base1")
            .then(function (num) {
                return add(num, "--");
            })
            .then(function (num) {
                return add(num, "--");
            })
            .then(function (num) {
                return add(num, "--");
            })
            .rootResolve(0);

            setTimeout(function () {
                var back = promise
                .tag("back");
                write("");
                write("");
                write("tag back");
                write("setTimeout 6000...Is already done?");
                write("branch:" + back.checkout());
                write("status:" + back.state);

                back
                .then(function (num) {
                    write("");
                    write("branch:" + this.checkout() + ";num:" + num)
                    return num;
                })
                .then(function (num) {
                    return add(num, "--");
                })

            }, 6000);

            var promiseDelete = new Promise(add1, add);
            promiseDelete.then(add)
            .then(add)
            .branch(add, "test1")
                .then(add)
            .reBranch()
                .then(add)
                .then(add)
            .removeTree();
            write("");
            write("promiseDelete.thens.length:" + promiseDelete.thens.length);
            write("");
        });
    </pre>
</body>
</html>
